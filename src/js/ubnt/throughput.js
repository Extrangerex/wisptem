var ready=false;var data_timer=0;var max_data=20;var stats_data={};var last_uptime=0;var dev_uptime=0;var plots=[];$(document).ready(refreshAll);function refreshAll(){if(typeof reloadStatus=="function"){reloadStatus()}reloadData()}function reloadData(action,ip,user,pass){if(!document.getElementById("throughput")){return}$.ajax({url:"formemisor.php?action="+action+"&ip="+ip+"&user="+user+"&pass="+pass,cache:false,timeout: 15000,dataType:"json",success:updateGraphs});return false}function update_all(d,c,b,a){c.add_values([b,a],dev_uptime-last_uptime);updateCanvas(d,c)}function normalize_max(e,c){var f=e/c;var d=Math.pow(10,Math.floor(Math.log(f)/Math.LN10));var b=f/d;var a=10;if(b<1.5){a=1}else{if(b<2.25){a=2}else{if(b<3){a=2.5}else{if(b<7.5){a=5}}}}a*=d;if(Math.floor(e/a)*a>=e){return e}return(Math.floor(e/a)+1)*a}function normalize_float(a){if(!a){return 0}if(a>100){return toFixed(a,0)}if(a>10){return toFixed(a,1)}return toFixed(a,2)}function normalize_tick(b){var a=(Math.round(b*100)/100).toString(10);var c=a.lastIndexOf(".");if(c!=-1&&c<a.length-2){a=a.substr(0,c+3)}return a}function formatBPS(c){var b;var a;if(Math.round(c)<1024){b="bps";a=0}else{if(Math.round(c/1024)<1024){c=c/1024;b="kbps";a=1}else{c=c/1024/1024;b="Mbps";a=2}}c=normalize_float(c);return[c,b,a,""+c+b]}function getOptions(b,a){var c={xaxes:[{ticks:max_data,tickFormatter:function(d){return""},min:0,max:max_data}],yaxes:[{ticks:8,tickFormatter:function(d){return(d!=0)?normalize_tick(d):b+" 0"},min:0,max:a}],legend:{position:"nw",backgroundOpacity:0.4}};return c}function updateCanvas(i,c){if(!document.getElementById(i)){return}var h=c.get_plot_values();var f=formatBPS(h[3][0])[3];var a=formatBPS(h[3][1])[3];var g=[{data:h[0][0],label:"RX: "+f,color:"#2389C6"},{data:h[0][1],label:"TX: "+a,color:"#FF0000"}];var b=getOptions(h[1],h[2]);if(plots[i]){var e=plots[i];$.extend(true,e.getOptions(),b);e.setData(g);e.setupGrid();e.draw()}else{plots[i]=$.plot($("#"+i),g,b)}}function PlotData(c,a){this.max_data=a;this.last=new Array(c);this.data=new Array(c);this.shifted=new Array(c);for(var b=0;b<c;++b){this.last[b]=0;this.data[b]=new Array();this.shifted[b]=false}this.add_values=function(d,f){var g;if(f<=0){return}for(var e=0;e<this.data.length;++e){if(this.data[e].length>=this.max_data){this.data[e].shift()}if(d[e]){g=parseFloat(d[e]);if(this.data[e].length==0){this.last[e]=g}if(g<this.last[e]){if(this.last[e]>2147483647){this.data[e].push((4294967295-this.last[e]+g)/f*8)}else{if((this.last[e]+g)<2415919103){this.data[e].push(g/f*8)}else{this.data[e].push((2147483647-this.last[e]+g)/f*8)}}}else{this.data[e].push((g-this.last[e])/f*8)}this.last[e]=g}else{this.data[e].push(0)}if(!this.shifted[e]&&this.data[e].length==2){this.data[e].shift();this.shifted[e]=true}}};this.get_plot_values=function(){var e=100;var h,f;var g,l;var k=[];var d=[];for(h=0;h<this.data.length;++h){d[h]=[];for(f=0;f<this.data[h].length;++f){g=this.data[h][f];if(g>e){e=g}d[h][f]=[f,g]}k[h]=this.data[h][f-1]}l=formatBPS(e);e=normalize_max(l[0],8);if(l[2]>0){for(h=0;h<d.length;++h){for(f=0;f<d[h].length;++f){d[h][f][1]/=Math.pow(1024,l[2])}}}return[d,l[1],e,k]}}function buildHeaderRow(a,b){var c=[];c.push('<tr><td align="center"><span id="label'+a+'"></span></td>');c.push(b?'<td align="center"><span id="label'+(a+1)+'"></span></td></tr>':'<td width="50%">&nbsp;</td></tr>');return c.join("")}function buildGraphRow(a,b){var c=[];c.push('<tr><td colspan="2"><div class="graph-border"><div id="canvas'+a+'" class="graph-canvas"></div></div>');c.push(b?'<div class="graph-border"><div id="canvas'+(a+1)+'" class="graph-canvas"></div></div>':"<td>&nbsp;</td></tr>");return c.join("")}function buildStatsObj(a){var b={};b.canvas="canvas"+a;b.data=new PlotData(2,max_data);return b}function initGraphs(e){stats_data={};last_uptime=0;dev_uptime=0;plots=[];$("#throughput > tbody").empty();var b=e.interfaces.length;stats_data.length=b;for(var a=0;a<b;a+=2){var c=[];c.push(buildHeaderRow(a,a+1<b));c.push(buildGraphRow(a,a+1<b));$(".loaders").hide();$("#throughput > tbody").append(c.join(""));stats_data[e.interfaces[a].ifname]=buildStatsObj(a);$("#label"+a).text(devname2uidevname(e.interfaces[a].ifname));if(a+1<b){stats_data[e.interfaces[a+1].ifname]=buildStatsObj(a+1);$("#label"+(a+1)).text(devname2uidevname(e.interfaces[a+1].ifname))}}}function updateGraphs(c){if(!c){if(typeof reloadStatus=="function"){reloadStatus()}else{window.location.reload()}return}if(!stats_data.length||stats_data.length!=c.interfaces.length){initGraphs(c)}dev_uptime=c.host.uptime;for(var b=0;b<c.interfaces.length;++b){var e=c.interfaces[b];if(stats_data[e.ifname]){var a=stats_data[e.ifname];update_all(a.canvas,a.data,e.stats.rx_bytes,e.stats.tx_bytes)}}ready=true;last_uptime=dev_uptime};